<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Needle</title>
  <link href="${cssUri}" rel="stylesheet" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src ${webview.cspSource}; style-src ${webview.cspSource}; script-src 'nonce-${nonce}';">
</head>
<body>
  <div class="search-container">
    <div class="heading">Search your codebase semantically</div>
    <form id="searchForm">
      <input id="queryInput" type="text" placeholder="Ask your code..." />
      <button id="searchButton" type="submit">Search</button>
    </form>
    
    <div class="exclusion-container">
      <label for="exclusionInput">Exclude:</label>
      <input id="exclusionInput" type="text" placeholder="e.g., *.{json,md,txt}" title="Regex pattern to exclude files from search" />
    </div>
    
    <div class="actions-container">
      <button id="regenerateButton" class="regen-button" title="Regenerate the embeddings cache file">Regenerate Index</button>
    </div>
    
    <div id="notification" class="notification" style="display: none;"></div>
  </div>
  
  <div id="loadingIndicator" class="loading" style="display: none;">
    Searching code...
  </div>
  
  <div id="resultsContainer"></div>

  <script nonce="${nonce}">
    // Debug utility - add to the top of your script
    setTimeout(() => {
      vscode.postMessage({ type: 'debug' });
    }, 500);

    const vscode = acquireVsCodeApi();
    const resultsContainer = document.getElementById('resultsContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const notification = document.getElementById('notification');
    const exclusionInput = document.getElementById('exclusionInput');

    document.getElementById('searchForm').addEventListener('submit', (e) => {
      e.preventDefault();
      search();
    });
    
    document.getElementById('regenerateButton').addEventListener('click', (e) => {
      e.preventDefault();
      regenerateEmbeddings();
    });

    function search() {
      const query = document.getElementById('queryInput').value;
      const exclusionValue = document.getElementById('exclusionInput').value.trim();
      console.log('UI sending search with exclusion pattern:', exclusionValue);
      
      if (query.trim() !== '') {
        loadingIndicator.style.display = 'block';
        resultsContainer.innerHTML = '';
        vscode.postMessage({ 
          type: 'search', 
          query,
          exclusionPattern: exclusionValue
        });
      }
    }
    
    function regenerateEmbeddings() {
      const exclusionValue = document.getElementById('exclusionInput').value.trim();
      console.log('UI sending regenerate with exclusion pattern:', exclusionValue);
      
      notification.style.display = 'none';
      loadingIndicator.style.display = 'block';
      loadingIndicator.textContent = 'Regenerating embeddings cache...';
      vscode.postMessage({ 
        type: 'regenerateEmbeddings',
        exclusionPattern: exclusionValue
      });
    }

    function openFile(filePath, lineStart, lineEnd) {
      vscode.postMessage({
        type: 'openFile',
        filePath,
        lineStart,
        lineEnd
      });
    }

    window.addEventListener('message', event => {
      const message = event.data;

      if (message.type === 'searchResults') {
        loadingIndicator.style.display = 'none';
        displayResults(message.results);
      } else if (message.type === 'searchError') {
        loadingIndicator.style.display = 'none';
        notification.textContent = 'Error: ' + message.message;
        notification.className = 'notification error';
        notification.style.display = 'block';
      } else if (message.type === 'regenerationSuccess') {
        loadingIndicator.style.display = 'none';
        notification.textContent = 'Embeddings cache regenerated successfully.';
        notification.className = 'notification success';
        notification.style.display = 'block';
        setTimeout(() => {
          notification.style.display = 'none';
        }, 5000);
      } else if (message.type === 'regenerationError') {
        loadingIndicator.style.display = 'none';
        notification.textContent = 'Error: ' + message.message;
        notification.className = 'notification error';
        notification.style.display = 'block';
      }
    });

    function displayResults(results) {
      resultsContainer.innerHTML = '';

      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="no-results">No matching results found</div>';
        return;
      }

      results.forEach(result => {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.onclick = () => openFile(result.filePath, result.lineStart, result.lineEnd);

        const fileName = result.filePath.split('/').pop().split('\\\\').pop();

        resultItem.innerHTML = `
          <div class="result-header">
            <span>${fileName}:${result.lineStart + 1}</span>
            <span class="result-score">${result.score.toFixed(2)}</span>
          </div>
          <div class="result-path">${escapeHtml(result.filePath)}</div>
          <div class="result-context">${escapeHtml(result.context || '')}</div>
          <div class="result-preview">${highlightCode(result.code)}</div>
        `;

        resultsContainer.appendChild(resultItem);
      });
    }

    function highlightCode(code) {
      const escapedCode = escapeHtml(code);
      const maxLines = 7;
      const lines = escapedCode.split('\n');
      let displayCode = lines.slice(0, maxLines).join('\n');
      if (lines.length > maxLines) {
        displayCode += '\n...';
      }
      return displayCode;
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>